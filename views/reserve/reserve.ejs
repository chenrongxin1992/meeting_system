<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>会议室申请</title>

    <!-- Bootstrap -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->
    <link rel='stylesheet' href='/stylesheets/bootstrapValidator.min.css' />
    <link rel='stylesheet' href='/stylesheets/jquery-ui.css' />
    <link rel='stylesheet' href='/stylesheets/bootstrap-select.css' />
    <style type="text/css">
      h3{
        padding-top: 10px;
      }
      .apply_form{
        height: 30px;
        line-height: 30px;
      }
      hr{
        margin-bottom: 20px;
        border: 0;
        border-top: 1px solid #d0a8a8;
        margin-top: 0px;
      }
      #ui-datepicker-div{
        display: none;
      }

      .bootstrap-select > .dropdown-toggle{
        width: auto;
      }
      .dropdown-menu > .open{
        width: auto;
      }
      .bootstrap-select.btn-group .dropdown-menu{
        min-width: 10%;
      }
      .to{
        width: 10px;
        font-size: medium;
        line-height: 34px;
        padding-left: 0px;
      }
      @media screen and (max-width:1024px){
        .to{ 
            width: 10px;
            font-size: medium;
            line-height: 34px;
            padding-left:20px;
         }
      }
     
   
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="/javascripts/html5shiv.min.js"></script>
      <script src="/javascripts/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-5 col-md-offset-1">
          <img src="/images/szucsselogo.png" class="img-responsive" alt="Responsive image"/>
          
        </div>
        <div class="col-md-5"><h3>会议室申请</h3></div>
      </div>
      <div class="row apply_form">
        <div class="col-md-3 col-md-offset-3"><h4>会议室申请表</h4></div>
        <div class="col-md-6 pull-left"><span style="line-height: 39px"><a href="/reserve/meeting">返回</a> | <a href="/manage/record">查询申请记录</a></span></div>
        
      </div>

      <div class="row">
        <div class="col-md-7 col-md-offset-1"><hr></div>
      </div>

      <form class="form-horizontal" role="form">

        <div class="form-group">
          <label for="room_name" class="col-sm-2 col-sm-offset-1 control-label">会议室</label>
          <div class="col-sm-4">
            <select id="room_name" class="selectpicker" data-hide-disabled="true" data-live-search="false">
                  <% for(let i=0;i<data.length;i++) { %>
                    <option><%=data[i]%></option>
                  <% } %>
              </select>
          </div>
        </div>

        <div class="form-group">
          <label for="meeting_name" class="col-sm-2 col-sm-offset-1 control-label">会议名称</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" id="meeting_name" 
                 placeholder="请输入会议名称">
          </div>
          
        </div>
        <div class="form-group">
          <label for="meeting_num" class="col-sm-2 col-sm-offset-1 control-label">参会人数</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" id="meeting_num" 
                 placeholder="请输入人数">
          </div>
        </div>
        
        <div class="form-group">
          <label for="meeting_content" class="col-sm-2 col-sm-offset-1 control-label">会议内容</label>
          <div class="col-sm-4">
            <textarea class="form-control" rows="3" id="meeting_content" placeholder="请输入会议内容"></textarea>
          </div>
        </div>
        
        
        <div class="form-group">
          <label for="apply_name" class="col-sm-2 col-sm-offset-1 control-label">申请人</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" id="apply_name" 
                 placeholder="请输入申请人">
          </div>
        </div>
        
        <div class="form-group">
          <label for="phone" class="col-sm-2 col-sm-offset-1  control-label">联系电话</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" id="apply_phone" 
                 placeholder="请输入手机号码">
          </div>
        </div>

        <div class="form-group">
          <label for="email" class="col-sm-2 col-sm-offset-1  control-label">邮箱</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" id="apply_email" 
                 placeholder="用于接收审批结果通知">
          </div>
        </div>
        
        <div class="form-group">
          <label for="meeting_date" class="col-sm-2 col-sm-offset-1 control-label">会议日期</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" id="meeting_date">
          </div>
        </div>
        
        <!-- <div class="form-group">
          <label for="meeting_time" class="col-sm-2 col-sm-offset-1 control-label">会议时间</label>
          <div class="col-sm-4">
            <input type="text" class="form-control" id="meeting_time" 
                 placeholder="请输入会议时间">
              <select id="meeting_time" class="selectpicker" data-hide-disabled="true" data-live-search="false">
                <optgroup label="上午">
                  <option>08:30-09:30</option>
                  <option>09:30-10:30</option>
                  <option>10:30-11:30</option>
                </optgroup>
                <optgroup label="中午">
                  <option>12:00-13:00</option>
                  <option>13:00-14:30</option>
                </optgroup>
                <optgroup label="下午">
                  <option>14:30-15:30</option>
                  <option>15:30-16:30</option>
                  <option>16:30-17:30</option>
                </optgroup>
                <optgroup label="晚上">
                  <option>18:00-19:00</option>
                  <option>19:00-20:00</option>
                  <option>20:00-21:00</option>
                </optgroup>
              </select>
          </div>
        </div> -->

        <!-- 尝试切割时间 -->
        <div class="form-group">
          <label for="shijianduan" class="col-sm-2 col-sm-offset-1 control-label">会议时间段</label>
          <div class="col-sm-4">
            <select id="shijianduan" class="selectpicker" data-hide-disabled="true" data-live-search="false" >
              <option>上午</option>
              <option>中午</option>
              <option>下午</option>
              <option>晚上</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="meeting_time" class="col-sm-2 col-sm-offset-1 control-label  col-xs-3">会议时间</label>
          <div class="col-sm-1  col-xs-3">
            <select id="first_hour" class="selectpicker" data-hide-disabled="true" data-live-search="false">
                <option>08</option>
                <option>09</option>
                <option>10</option>
                <option>11</option>
            </select>
          </div> 
          <div class="col-sm-1   col-xs-3">
            <select id="first_minute" class="selectpicker" data-hide-disabled="true" data-live-search="false">
              <option>00</option>
              <option>30</option>
            </select>
          </div> 
          <div class="col-sm-1 to  col-xs-4">To</div>
          <div class="col-sm-1  col-xs-3">
            <select id="second_hour" class="selectpicker" data-hide-disabled="true" data-live-search="false">
                <option>09</option>
                <option>10</option>
                <option>11</option>
            </select>
          </div> 
          <div class="col-sm-1  col-xs-3 ">
            <select id="second_minute" class="selectpicker" data-hide-disabled="true" data-live-search="false">
              <option>00</option>
              <option>30</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <div class="col-sm-offset-3 col-sm-10">
            <button type="button" class="btn btn-success" id="now-submit">提交</button>
          </div>
        </div>
      </form>

      <div class="row">
        <div class="col-sm-7 col-sm-offset-1"><hr></div>
      </div>

      <div class="row">
        <div class="col-md-5 col-md-offset-2">
          <address><p class="pull-right">©深圳大学 计算机与软件学院</p><p>©2017 </p></address>
        </div>
      </div>
</div>
    
        
    <script type="text/javascript" src='/javascripts/jquery-1.10.2.min.js'></script>
    <!-- <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script> -->
    <script type="text/javascript" src='/javascripts/bootstrap.min.js' ></script>
    <script type="text/javascript" src='/javascripts/jquery-ui-datepicker.js' ></script>
    <script type="text/javascript" src='/javascripts/moment.js' ></script>
    <script type="text/javascript" src='/javascripts/bootstrap-select.js' ></script>
    <script type="text/javascript">
      jQuery.browser={};(function(){jQuery.browser.msie=false; 
      jQuery.browser.version=0;if(navigator.userAgent.match(/MSIE ([0-9]+)./)){ jQuery.browser.msie=true;jQuery.browser.version=RegExp.$1;}})();
    </script>

    <script type="text/javascript">
      $(document).ready(function(){
        //动态改变时间段
        //$("#select_id").change(function(){//code...});
        $('#shijianduan').change(function(){
          var temp_shijianduan = $('#shijianduan option:selected').val()
          console.log('temp_shijianduan-->',temp_shijianduan)
          if(temp_shijianduan == '上午'){
            console.log('上午')
              $("#first_hour option").remove()
              $("#first_hour").append("<option>"+'08'+"</option>");    
              $("#first_hour").append("<option>"+'09'+"</option>");
              $("#first_hour").append("<option>"+'10'+"</option>");
              $("#first_hour").append("<option>"+'11'+"</option>");
              $("#first_hour").selectpicker("refresh")

              $("#second_hour option").remove()
              $("#second_hour").append("<option>"+'08'+"</option>");    
              $("#second_hour").append("<option>"+'09'+"</option>");
              $("#second_hour").append("<option>"+'10'+"</option>");
              $("#second_hour").append("<option>"+'11'+"</option>");
              $("#second_hour").selectpicker("refresh")
          }
          else if(temp_shijianduan == '中午'){
              console.log('中午')
              $("#first_hour option").remove()
              $("#first_hour").append("<option>"+'12'+"</option>");    
              $("#first_hour").append("<option>"+'13'+"</option>");
              $("#first_hour").append("<option>"+'14'+"</option>");
              $("#first_hour").selectpicker("refresh")

              $("#second_hour option").remove()
              $("#second_hour").append("<option>"+'12'+"</option>");    
              $("#second_hour").append("<option>"+'13'+"</option>");
              $("#second_hour").append("<option>"+'14'+"</option>");
              $("#second_hour").selectpicker("refresh")
          }
          else if(temp_shijianduan == '下午'){
              console.log('下午')
              $("#first_hour option").remove()
              $("#first_hour").append("<option>"+'14'+"</option>");    
              $("#first_hour").append("<option>"+'15'+"</option>");
              $("#first_hour").append("<option>"+'16'+"</option>");
              $("#first_hour").append("<option>"+'17'+"</option>");
              $("#first_hour").selectpicker("refresh")

              $("#second_hour option").remove()
              $("#second_hour").append("<option>"+'14'+"</option>");    
              $("#second_hour").append("<option>"+'15'+"</option>");
              $("#second_hour").append("<option>"+'16'+"</option>");
              $("#second_hour").append("<option>"+'17'+"</option>");
              $("#second_hour").selectpicker("refresh")
          }
          else{
            console.log('晚上')
            $("#first_hour option").remove()
              $("#first_hour").append("<option>"+'18'+"</option>");    
              $("#first_hour").append("<option>"+'19'+"</option>");
              $("#first_hour").append("<option>"+'20'+"</option>");
              $("#first_hour").append("<option>"+'21'+"</option>");
              $("#first_hour").selectpicker("refresh")

              $("#second_hour option").remove()
              $("#second_hour").append("<option>"+'18'+"</option>");    
              $("#second_hour").append("<option>"+'19'+"</option>");
              $("#second_hour").append("<option>"+'20'+"</option>");
              $("#second_hour").append("<option>"+'21'+"</option>");
              $("#second_hour").selectpicker("refresh")
          }
        })
        //时间选择
        $('#meeting_date').datepicker({
           format: 'yyyy-mm-dd',
           minDate:0,
           maxDate:28
        });
        //初始化时间
        let date = moment().format('YYYY-MM-DD')
        $('#meeting_date').val(date)
        console.log('初始化时间',date)

        $('#now-submit').on("click",function(){
          let room_name = $('#room_name option:selected').val(),
              meeting_name = $('#meeting_name').val(),
              meeting_num = $('#meeting_num').val(),
              meeting_content = $('#meeting_content').val(),
              apply_name = $('#apply_name').val(),
              apply_phone = $('#apply_phone').val(),
              meeting_date = $('#meeting_date').val(),
              meeting_time = $('#meeting_time option:selected').val(),
              apply_email = $('#apply_email').val(),
              first_hour = $('#first_hour option:selected').val(),
              first_minute = $('#first_minute option:selected').val(),
              second_hour = $('#second_hour option:selected').val(),
              second_minute = $('#second_minute option:selected').val()

          if(first_hour > second_hour){
            $('.modal-msg').modal('show')
            $('.modal-body').text('开始时间不能大于结束时间！')
            return false
          }
          if(first_hour == second_hour && first_minute > second_minute){
            $('.modal-msg').modal('show')
            $('.modal-body').text('开始时间不能大于结束时间！')
            return false
          }
          if(first_hour == second_hour && first_minute == second_minute){
            $('.modal-msg').modal('show')
            $('.modal-body').text('请选择会议时间')
            return false
          }

          //临时测试数据
          /*room_name = '938'
          meeting_name = '测试'
          meeting_num = '22'
          meeting_content = 'for test'
          apply_name = 'dddd'
          apply_phone = '13760277012'
          apply_email = '848536190@qq.com'*/

          if(!meeting_name || typeof meeting_name == 'undefined'){
            $('.modal-msg').modal('show')
            $('.modal-body').text('会议名称不能为空！')
            //alert('会议室编号或名称不能为空！')
            return false
          }
          if(meeting_name.length > 30){
            $('.modal-msg').modal('show')
            $('.modal-body').text('会议名称长度超过30！')
            //alert('会议名称长度超过30！')
            return false
          }
          if(!meeting_num || typeof meeting_num == 'undefined'){
              $('.modal-msg').modal('show')
              $('.modal-body').text('参会人数不能为空！')
            
            //alert('参会人数不能为空！')
            return false
          }
          /*let judge = /^[1-9]+[0-9]*]*$/
          if(!judge.exec(meeting_num)){
              $('.modal-msg').modal('show')
              $('.modal-body').text('参会人数只能为正整数！')
              return 
            }*/
          if(!meeting_content || typeof meeting_content == 'undefined'){
            $('.modal-msg').modal('show')
            $('.modal-body').text('会议内容不能为空!')
            //alert('会议内容不能为空!')
            return false
          }
          if(meeting_content.length > 300){
            $('.modal-msg').modal('show')
            $('.modal-body').text('会议内容过长！')
            //alert('会议内容过长！')
            return false
          }
          if(!apply_name || typeof apply_name == 'undefined'){
            $('.modal-msg').modal('show')
            $('.modal-body').text('申请人不能为空！')
            //alert('申请人不能为空！')
          }
          if(!apply_phone || typeof apply_phone == 'undefined'){
            $('.modal-msg').modal('show')
            $('.modal-body').text('手机号码不能为空！')
            return 
            //alert('联系号码不能为空！')
          }
          let checkphone = /^1(3|4|5|7|8)\d{9}$/
          if(!checkphone.exec(apply_phone)){
              $('.modal-msg').modal('show')
              $('.modal-body').text('请输入正确的手机号！')
              return 
          }
          console.log('check email: ',apply_email)
          if(!apply_email || typeof apply_email == 'undefined'){
            $('.modal-msg').modal('show')
            $('.modal-body').text('邮箱不能为空！')
            return 
          }
          let checkemail = /^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/
          if(!checkemail.exec(apply_email)){
              $('.modal-msg').modal('show')
              $('.modal-body').text('请输入正确的邮箱！')
              return 
          }
          //return 


          console.log('check args',room_name,meeting_name,meeting_num,meeting_content,apply_name,apply_phone,meeting_date,meeting_time)

          meeting_date = meeting_date.substring(5)
          console.log('meeting_date-->',meeting_date)
          let temp_meeting_date = meeting_date.split('-')
          meeting_date = temp_meeting_date[0] + '月' + temp_meeting_date[1] + '日'
          console.log('meeting_date-->',meeting_date)

          /*let temp_meeting_time = meeting_time.substring(0,2),
              exact_meeting_time = ''
          console.log('临时截取时间：',temp_meeting_time)
          if(temp_meeting_time == '08' || temp_meeting_time == '09' || temp_meeting_time == '10'){
            exact_meeting_time = '上午' + meeting_time
            meeting_time = '上午'
          }
          if(temp_meeting_time == '12' || temp_meeting_time == '13'){
            exact_meeting_time = '中午' + meeting_time 
            meeting_time = '中午'
          }
          if(temp_meeting_time == '14' || temp_meeting_time == '15' || temp_meeting_time == '16'){
            exact_meeting_time = '下午' + meeting_time
            meeting_time = '下午'
          }
          if(temp_meeting_time == '19' || temp_meeting_time == '18' || temp_meeting_time == '20'){
            exact_meeting_time = '晚上' + meeting_time
            meeting_time = '晚上'
          }
          console.log('meeting_time: ',meeting_time)
          console.log('exact_meeting_time: ',exact_meeting_time)*/
          console.log('first_hour-->',first_hour,'first_minute-->',first_minute,'second_hour-->',second_hour,'second_minute-->',second_minute)
          if(first_hour == '08' || first_hour == '09' || first_hour == '10' || first_hour == '11'){
            meeting_time = '上午'
            exact_meeting_time = '上午' + first_hour + ':' + first_minute + '-' + second_hour + ':' + second_minute
          }
          if(first_hour == '12' || first_hour == '13' ){
            meeting_time = '中午'
            exact_meeting_time = '中午' + first_hour + ':' + first_minute + '-' + second_hour + ':' + second_minute
          }
          if(first_hour == '14' || first_hour == '15' || first_hour == '16' || first_hour == '17'){
            meeting_time = '下午'
            exact_meeting_time = '下午' + first_hour + ':' + first_minute + '-' + second_hour + ':' + second_minute
          }
          if(first_hour == '18' || first_hour == '19' || first_hour == '20' || first_hour == '21'){
            meeting_time = '晚上'
            exact_meeting_time = '晚上' + first_hour + ':' + first_minute + '-' + second_hour + ':' + second_minute
          }
          console.log('meeting_time-->',meeting_time)
          console.log('exact_meeting_time-->',exact_meeting_time)

          $.ajax({
            url: '/manage/applyTwo', 
            async: true,
            dataType: 'json',
            type: 'POST',
            data: {
              room_name:room_name,
              meeting_name:meeting_name,
              meeting_num:meeting_num,
              meeting_content:meeting_content,
              apply_name:apply_name,
              apply_phone:apply_phone,
              meeting_date:meeting_date,
              meeting_time:meeting_time,
              exact_meeting_time:exact_meeting_time,
              apply_email:apply_email,
              first_hour:first_hour,
              first_minute:first_minute,
              second_hour:second_hour,
              second_minute:second_minute
            },

            success: function(result){
              console.log('success')
              console.log(result)
              if(result.errCode == 0){
                //弹出模态框
                $('.result-modal').modal('show')
                $('.modal-body').text('申请操作成功，请等待审批。')
                //$('.modal-msg').attr('myid',result.result._id);
                $('.modal-msg').attr('apply_name',apply_name);
              }
              if(result.errCode == -1){
                //弹出模态框
                $('.result-modal').modal('show')
                $('.modal-body').text(result.errMsg)
              }
            },
            error: function(e){
              console.log("error");
              //console.error(e.message)
              $('.result-modal').modal('show')
              $('.modal-body').text('申请操作失败')
            },
           
          });

          /*$.ajax({
            url: '/manage/apply', 
            async: true,
            dataType: 'json',
            type: 'POST',
            data: {
              room_name:room_name,
              meeting_name:meeting_name,
              meeting_num:meeting_num,
              meeting_content:meeting_content,
              apply_name:apply_name,
              apply_phone:apply_phone,
              meeting_date:meeting_date,
              meeting_time:meeting_time,
              exact_meeting_time:exact_meeting_time,
              apply_email:apply_email
            },

            success: function(result){
              console.log('success')
              console.log(result)
              if(result.errCode == 0){
                //弹出模态框
                $('.result-modal').modal('show')
                $('.modal-body').text('申请操作成功，请等待审批。')
              }
              if(result.errCode == -1){
                //弹出模态框
                $('.result-modal').modal('show')
                $('.modal-body').text(result.errMsg)
              }
            },
            error: function(e){
              console.log("error");
              //console.error(e.message)
              $('.result-modal').modal('show')
              $('.modal-body').text('申请操作失败')
            },
           
          });*/
        });
        $('#success-btn').on("click",function(){
          //window.location.reload()
        })
        $('#check_record').on("click",function(){
          let apply_name = $('.modal-msg').attr('apply_name');
          console.log('apply_name-->',apply_name)
          window.location.href = '/manage/recordByName' + '?apply_name=' + apply_name
        })
        $(".modal-msg").on("hidden.bs.modal", function() {
              console.log('---- here ----')
            //$(this).removeData("bs.modal");
            $(".modal-body").children().remove();  
            console.log('----- clear modal window -----')
            //$(".modal-body").remove()
            //console.log('----- clear again -----')
        });
      });
    
  </script>
  <!-- 模态框 -->
    <!-- Button trigger modal -->

    <!-- Modal -->
    <div class="modal fade modal-msg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="data-modal">
    <div class="modal-dialog modal-sm" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="gridSystemModalLabel">提示</h4>
        </div>
        <div class="modal-body">

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-default sure" data-dismiss="modal">确定</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 申请结果模态框 -->
  <div class="modal fade result-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="result-modal">
    <div class="modal-dialog " role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="gridSystemModalLabel">提交结果</h4>
        </div>
        <div class="modal-body">
        
        </div>
        <div class="modal-footer">
          <botton type="button" class="btn btn-default check_record" data-dismiss="modal" id="check_record">查询申请记录</botton>
          <button type="button" class="btn btn-success sure" data-dismiss="modal" id="success-btn">确定</button>
        </div>
      </div>
    </div>
  </div>
  </body>
</html>